---
# Note: tests that require setting global values must live in the parent chart, not the sub-chart!

suite: Test ingress
templates:
  - charts/astronomer/templates/ingress.yaml
tests:
  - it: Should be empty when baseDomain is not set
    asserts:
      - hasDocuments:
          count: 0

  - it: Should be ingress when baseDomain is set
    set:
      global.baseDomain: example.com
    asserts:
      - isKind:
          of: Ingress

  # TODO: We need tests here for the syntax changes in ingress between 1.18 and 1.19

  # This fails with our fork of helm-unittest, but manual testing shows that it should pass:
  # helm template . --set global.baseDomain=example.com --kube-version=1.19.0 --show-only charts/astronomer/templates/ingress.yaml
  #
  # - it: "Should use ingress networking.k8s.io/v1 with k8s >= 1.19"
  #   set:
  #     global.baseDomain: example.com
  #   capabilities:
  #     majorVersion: 1
  #     minorVersion: 19
  #   asserts:
  #     - equal:
  #         path: apiVersion
  #         value: networking.k8s.io/v1

  - it: "Should use ingress networking.k8s.io/v1beta1 with k8s < 1.19"
    set:
      global.baseDomain: example.com
    capabilities:
      majorVersion: 1
      minorVersion: 18
    asserts:
      - equal:
          path: apiVersion
          value: networking.k8s.io/v1beta1

  # This test passes with latest quintush but fails with our old fork. https://github.com/astronomer/issues/issues/2701
  # - it: "Should use ingress networking.k8s.io/v1 with k8s >= 1.19"
  #   set:
  #     global.baseDomain: example.com
  #   capabilities:
  #     majorVersion: 1
  #     minorVersion: 19
  #   asserts:
  #     - equal:
  #         path: apiVersion
  #         value: networking.k8s.io/v1
