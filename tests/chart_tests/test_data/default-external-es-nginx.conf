worker_processes 1;
pid /tmp/nginx.pid;
events { worker_connections 1024; }
error_log /dev/stdout info;
env ES_SECRET;
env ES_SECRET_NAME;

http {
  log_format cache_status '$remote_addr - $remote_user [$time_local] '
                          '"$request" $status $body_bytes_sent '
                          '"$http_referer" "$http_user_agent" '
                          'cache=$auth_cache_status';
  access_log /dev/stdout cache_status;
  client_max_body_size 1024M;

  proxy_cache_path /tmp/nginx-auth-cache levels=1:2 keys_zone=auth_cache:10m max_size=100m inactive=5m;

  server {
    listen 9200;
    auth_request /auth;
    auth_request_set $auth_cache_status $upstream_cache_status;
    proxy_http_version 1.1;
    proxy_set_header Connection "Keep-Alive";
    proxy_set_header Proxy-Connection "Keep-Alive";

    # The following "location" rules limit airflow interactions to only their indices. Any further
    # additions should follow this pattern.
    location ~* /_count$ {
      rewrite /_count(.*) /fluentd.$remote_user.*/_count$1 break;          
      access_by_lua_file /usr/local/openresty/nginx/conf/setenv.lua;
      proxy_pass https://esdemo.example.com:;
      proxy_ssl_verify off;
    }

    location ~* /_bulk$ {
      rewrite /_bulk(.*) /fluentd.$remote_user.*/_bulk$1 break;          
      access_by_lua_file /usr/local/openresty/nginx/conf/setenv.lua;
      proxy_pass https://esdemo.example.com:;
      proxy_ssl_verify off;
    }

    location ~* /_search$ {
      # This combined with disabling explicit index searching downstream
      # prevents any deployment from being able to query any other indexes.
      rewrite /_search(.*) /fluentd.$remote_user.*/_search$1 break;          
      access_by_lua_file /usr/local/openresty/nginx/conf/setenv.lua;
      proxy_pass https://esdemo.example.com:;
      proxy_ssl_verify off;
    }

    location = /auth {
      internal;
      proxy_cache auth_cache;
      proxy_cache_key "$http_authorization";
      proxy_cache_valid 200 5m;
      proxy_cache_valid 401 403 1m;
      proxy_ignore_headers Cache-Control Expires;
      add_header X-Auth-Cache-Status $upstream_cache_status always;
      proxy_pass http://release-name-houston.default:8871/v1/elasticsearch;
      proxy_pass_request_body off;
      proxy_set_header Content-Length "";
      proxy_set_header X-Original-URI $request_uri;
    }

    location = /_cluster/state/version {          
      access_by_lua_file /usr/local/openresty/nginx/conf/setenv.lua;
      proxy_pass https://esdemo.example.com:;
      proxy_ssl_verify off;
    }

    location = /_cluster/health {          
      access_by_lua_file /usr/local/openresty/nginx/conf/setenv.lua;
      proxy_pass https://esdemo.example.com:;
      proxy_ssl_verify off;
    }

  }
  server {
    listen 9201;
    proxy_http_version 1.1;
    proxy_set_header Connection "Keep-Alive";
    proxy_set_header Proxy-Connection "Keep-Alive";

    location ~ ^/ {          
      access_by_lua_file /usr/local/openresty/nginx/conf/setenv.lua;
      proxy_pass https://esdemo.example.com:;
      proxy_ssl_verify off;
    }
  }
}