---
# Good example of multi-template test. statefulset requires configmap to be present to be
# rendered. The two template files must be tested with different assertions, so each test
# references the template that it is valid for. configmap has no global assertions though,
# so its tests live in the sub-chart, not the parent chart.

suite: Test alertmanager-statefulset
templates:
  - charts/alertmanager/templates/alertmanager-statefulset.yaml
  - charts/alertmanager/templates/alertmanager-configmap.yaml
tests:
  - it: should work
    template: charts/alertmanager/templates/alertmanager-statefulset.yaml
    set:
      global.platformNodePool:
        platformNodePool:
          nodeSelector: {}
          affinity: {}
          tolerations: []
    asserts:
      - isKind:
          of: StatefulSet
  - it: Alertmanager should have an fsGroup apiVersion
    template: charts/alertmanager/templates/alertmanager-statefulset.yaml
    set:
      global.platformNodePool:
        platformNodePool:
          nodeSelector: {}
          affinity: {}
          tolerations: []
    asserts:
      - isNotEmpty:
          path: spec.template.spec.securityContext.fsGroup
      - equal:
          path: spec.template.spec.securityContext.fsGroup
          value: 65534
  - it: should work
    template: charts/alertmanager/templates/alertmanager-statefulset.yaml
    asserts:
      - isKind:
          of: StatefulSet
  - it: should have POD_IP environment variable and cluster.advertise args if enableNonRFC1918 is true
    template: charts/alertmanager/templates/alertmanager-statefulset.yaml
    set:
      enableNonRFC1918: false
    assert:
      contains:
        path: containers.env.name
        content:
          name: POD_IP
      matchRegex:
        path: containers.args
        pattern: --cluster.advertise-address=\$\(POD_IP\):9094$
      