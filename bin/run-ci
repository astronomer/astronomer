#!/usr/bin/env bash
set -euo pipefail

# Bit of common bash magic that sets DIR to the directory of this script
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
# The path to the working directory - the root of the repo
REPO_DIR=$DIR/../

source $REPO_DIR/bin/install-ci-tools

source $REPO_DIR/bin/setup-kind

echo "Deploying Astronomer..."

# This is so CI does not timeout on "no input in 10 minutes"
kubectl get pods -n astronomer -w &
WATCH_PID=$!

$DIR/install-platform

sleep 5

$DIR/waitfor-platform

kill $WATCH_PID
