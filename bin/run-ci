#!/usr/bin/env bash
# shellcheck disable=SC1090
set -euo pipefail

BIN_DIR="${0%/*}"
REPO_DIR="$(git rev-parse --show-toplevel)"

source "$REPO_DIR/bin/install-ci-tools" 1
export PATH="$PATH:/tmp/bin"
ls -lh /tmp/bin

source "$REPO_DIR/bin/setup-kind"

echo "Deploying Astronomer..."

# Lint the platform while helm can talk to Kubernetes
# make lint

# This is so CI does not timeout on "no input in 10 minutes"
kubectl get pods -n astronomer -w &
WATCH_PID=$!

"$BIN_DIR/install-platform"

sleep 5

"$BIN_DIR/waitfor-platform"

"$BIN_DIR/setup-hosts"

# "$BIN_DIR/create-initial-user" "tester@astronomer.io" "password"

sudo kill -9 $WATCH_PID

### Test Platform
"$BIN_DIR/test-ap"
