#!/usr/bin/env bash
# This contents of this file must be compatible with CI and local dev workflows
set -euo pipefail

cd "$(mktemp -d)"

REPO_DIR="$(git rev-parse --show-toplevel)"

helm3 repo add astronomer-internal https://internal-helm.astronomer.io
helm3 repo update

pip3 install virtualenv
virtualenv --python=python3 /tmp/venv
# shellcheck disable=SC1091
source /tmp/venv/bin/activate
pip install -r "$REPO_DIR/bin/functional-tests/requirements.txt"
export NAMESPACE=astronomer
export RELEASE_NAME=astronomer

# Sleep twice the prometheus scrape period
# plus five seconds to allow for metrics to be
# collected, which the functional tests need.
sleep 65
pytest -s "$REPO_DIR/bin/functional-tests/"
deactivate
