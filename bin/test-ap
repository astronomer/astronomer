#!/usr/bin/env bash
# This contents of this file must be compatible with CI and local dev workflows
set -euo pipefail

cd "$(mktemp)"

REPO_DIR="$(git rev-parse --show-toplevel)"

pip3 install virtualenv
virtualenv --python=python3 /tmp/venv
# shellcheck disable=SC1091
source /tmp/venv/bin/activate
pip install -r "$REPO_DIR/bin/functional-tests/requirements.txt"
export NAMESPACE=astronomer
export RELEASE_NAME=astronomer
pytest "$REPO_DIR/bin/functional-tests/"
deactivate

# TODO: below this is legacy e2e tests that will be replaced

TESTING_VERSION="v0.0.1"

# get testing repo
ssh-agent bash -c 'ssh-add ~/.ssh/id_rsa_fbbd3c2fefafe95bfe330ee101809fcf; git clone git@github.com:astronomer/astro-testing.git'

# everything else happens from within the testing repo
cd astro-testing

# Checkout the version we want
git checkout $TESTING_VERSION

# build testing tools container, this should be removed when private docker build/usage is available
docker build -t astro/testing .

# Setup cert trust, this will get mounted into the container
cat "$(mkcert -CAROOT)/rootCA.pem" > root-ca.crt

# Setup .env file
cp env-example .env
echo "ASTRO_DOMAIN=local.astronomer-development.com" >> .env

# Run tests and capture exit code
set +e
./scripts/run-in-ci.sh
test_exit_code=$?
set -e

# Print debug info
kubectl get pods --all-namespaces
echo
echo "TEST EXIT CODE: $test_exit_code"

exit $test_exit_code
