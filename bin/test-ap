#!/usr/bin/env bash
set -euo pipefail

# Bit of common bash magic that sets DIR to the directory of this script
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
# The path to the working directory - the root of the repo
REPO_DIR=$DIR/../

helm3 repo add astronomer-internal https://internal-helm.astronomer.io
helm3 repo update

pip3 install virtualenv
virtualenv --python=python3 /tmp/venv
source /tmp/venv/bin/activate
pip install -r $REPO_DIR/bin/functional-tests/requirements.txt
export NAMESPACE=astronomer
export RELEASE_NAME=astronomer

sleep 40 # give prometheus time to collect metrics
pytest -s $REPO_DIR/bin/functional-tests/
deactivate

pyenv global 3.8.2
pip install --user pytest testinfra kubernetes
export PATH=/home/circleci/.local/bin:$PATH
kubectl create namespace astronomer-scan-test
pytest $REPO_DIR/bin/network-security-test.py
