#!/usr/bin/env bash
# shellcheck disable=SC1091
set -euo pipefail
set -x

# The path to the working directory - the root of the repo
GIT_ROOT="$(git -C "${0%/*}" rev-parse --show-toplevel)"
HELM_CHART_PATH=${HELM_CHART_PATH:-$GIT_ROOT}
RELEASE_NAME="${RELEASE_NAME:-astronomer}"
NAMESPACE="${NAMESPACE:-astronomer}"
HELM_TIMEOUT=${HELM_TIMEOUT:-800}

source "$GIT_ROOT/bin/helpers.sh"

if [[ -z "${ASTRONOMER_VERSION:-}" ]]; then
  ASTRONOMER_VERSION_LINE=""
else
  ASTRONOMER_VERSION_LINE="--version=$ASTRONOMER_VERSION"
fi

echo "Deploying Astronomer..."
ACTION="install"

# No args means to use the following settings
if [[ $# -eq 0 ]]; then
  platform=true
  logging=true
  monitoring=true
  postgresql=true
  mysql=false
  dryrun=""
else
  # Any args means be selective
  platform=false
  logging=false
  monitoring=false
  postgresql=false
  mysql=false
  for component in "$@" ; do
    case $component in
    install)
      ACTION="install" ;;
    template)
      ACTION="template" ;;
    dryrun)
      echo "Using --dry-run"
      dryrun="--dry-run" ;;
    *)
      echo "Setting ${component}=true"
      declare "${component}=true" ;;
    esac
  done
fi

if [[ "${postgresql}" == true ]] && [[ "${mysql}" == true ]]; then
  echo "ERROR: Cannot enable both postgresql and mysql"
  exit 1
fi

set +e

if [[ -z "${USE_HA+x}" ]]; then
  CONFIG_FILE=$GIT_ROOT/configs/local-dev.yaml
else
  CONFIG_FILE=$GIT_ROOT/configs/local-dev-ha.yaml
fi

set -x
# shellcheck disable=SC2086
if ! helm ${ACTION} \
  --namespace "$NAMESPACE" \
  "$RELEASE_NAME" \
  ${dryrun} \
  --timeout "${HELM_TIMEOUT}s" \
  -f "$CONFIG_FILE" \
  --set tags.platform="${platform}" \
  --set tags.logging="${logging}" \
  --set tags.monitoring="${monitoring}" \
  --set global.postgresqlEnabled="${postgresql}" \
  --set global.mysqlEnabled="${mysql}" \
  --set astronomer.houston.upgradeDeployments.enabled=true \
  $ASTRONOMER_VERSION_LINE \
  $HELM_CHART_PATH # cannot be quoted because it may contain a glob
then
  echo "Helm chart failed to install"
  get_debugging_info
  exit 1
else
  helm history -n "$NAMESPACE" "$RELEASE_NAME"
fi
