### basic workspace life cycle test

env WORKSPACE_NAME=tony-test

# login using bash expect
exec chmod +x login.sh
exec ./login.sh $ASTRO_USER $ASTRO_PASS

# test list workspaces
exec astro workspace list
stdout ' NAME[[:blank:]]+ID[[:space:]]+'
regexp @empty-workspace-list.txt stdout

# create a workspace
exec astro workspace create $WORKSPACE_NAME
stdout '.*Successfully created workspace.*'
! stderr '.+'
cp stdout workspace-list.txt

# add workspace id to env
exec bash -c 'cat workspace-list.txt | grep test | awk ''{ print $2 }'' | tr -d ''\n'''
env WORKSPACE_ID=@stdout
exec echo "WID: $WORKSPACE_ID"

# list the current workspaces
exec astro workspace list

# cleanup
exec astro workspace delete $WORKSPACE_ID


## Files used above

-- login.sh --
#!/usr/bin/expect -f

set timeout 5
set username [lindex $argv 0]
set password [lindex $argv 1]

# Start the login process
spawn astro auth login local.astronomer-development.com

# handle input/output
expect "*oAuth*"
send "$username\r"
expect "Password*"
send "$password\r"

# Expect the end
expect eof
