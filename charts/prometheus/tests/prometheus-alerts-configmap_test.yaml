---
suite: Test prometheus-alerts-configmap
templates:
  - prometheus-alerts-configmap.yaml
tests:
  - it: is the right type of resource
    asserts:
      - isKind:
          of: ConfigMap
  - it: contains exactly one document
    asserts:
      - hasDocuments:
          count: 1
  - it: renders the additional alerts configuration correctly
    release:
      name: my-release
      namespace: my-namespace
    set:
      additionalAlerts:
        airflow: |
          - alert: MyExampleAlert
            # If greater than 10% task failure
            expr: 100 * sum(increase(airflow_ti_failures[30m])) /  (sum(increase(airflow_ti_failures[30m])) + sum(increase(airflow_ti_successes[30m]))) > 10
            for: 15m
            labels:
              tier: airflow
            annotations:
              summary: The Astronomer Helm release {{ .Release.Name }} is failing task instances {{ printf "%q" "{{ printf \"%.2f\" $value }}%" }} of the time over the past 30 minutes
              description: Task instances failing above threshold
    asserts:
      - matchRegex:
          path: data.alerts
          pattern: '.*The Astronomer Helm release my-release is failing task instances {{ printf "%.2f" $value }}% of the time over the past 30 minutes.*'
