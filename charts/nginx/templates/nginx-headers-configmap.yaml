#####################
## NGINX ConfigMap ##
#####################
{{- $contentsrc := eq .Values.csp "full" | ternary .Values.connectsrc "" }}
{{- $fontsrc := eq .Values.csp "full" | ternary .Values.fontsrc "" }}
{{- $scriptsrc := eq .Values.csp "full" | ternary .Values.scriptsrc "" }}
{{- $stylesrc := eq .Values.csp "full" | ternary .Values.stylesrc "" }}
kind: ConfigMap
apiVersion: v1
metadata:
  name: {{ template "nginx.fullname" . }}-ingress-controller-headers
  labels:
    tier: {{ template "nginx.name" . }}
    chart: {{ template "nginx.chart" . }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
data:
  # https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy
  Content-Security-Policy: >-
    default-src 'self' *.{{ .Values.global.baseDomain }} ;
    connect-src *.{{ .Values.global.baseDomain }} wss://*.{{ .Values.global.baseDomain }} {{ $contentsrc}} ;
    font-src *.{{ .Values.global.baseDomain }} cdn.astronomer.io {{ $fontsrc }} data: ;
    frame-src 'self' ;
    img-src 'self' data: * ;
    script-src 'unsafe-inline' 'unsafe-eval' *.{{ .Values.global.baseDomain }} cdn.astronomer.io {{ $scriptsrc }} ;
    style-src 'unsafe-inline' *.{{ .Values.global.baseDomain }} cdn.jsdelivr.net {{ $stylesrc }} ;
    worker-src blob: *.{{ .Values.global.baseDomain }} ;
  Referrer-Policy: "same-origin"
  X-Frame-Options: "deny"
  X-XSS-Protection: "1; mode=block"
  X-Content-Type-Options: "nosniff"
  Feature-Policy: "autoplay 'none'; camera 'none'; encrypted-media 'none'; fullscreen 'none'; geolocation 'none'; microphone 'none'; midi 'none'; payment 'none'; xr-spatial-tracking 'none'"
