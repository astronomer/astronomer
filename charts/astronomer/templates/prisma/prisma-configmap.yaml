################################
## Astronomer Prisma ConfigMap
#################################
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-prisma-config
  labels:
    component: prisma
    tier: astronomer
    release: {{ .Release.Name }}
    chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
    heritage: {{ .Release.Service }}
data:
  config.yml: |
    port: {{ .Values.ports.prismaHTTP }}
    managementApiSecret: $PRISMA_MANAGEMENT_API_SECRET
    databases:
      default:
        connector: postgres
        {{ if and (.Values.prisma.backendSecretName) (not .Values.prisma.backendConnection) }}
        host: $PRISMA_DB_HOST
        port: $PRISMA_DB_PORT
        user: $PRISMA_DB_USER
        password: $PRISMA_DB_PASSWORD
        database: {{ printf "%s_houston" (.Release.Name | replace "-" "_")  }}
        {{ else if and (.Values.prisma.backendConnection) (not .Values.prisma.backendSecretName) }}
        host: {{ .Values.prisma.backendConnection.host }}
        port: {{ .Values.prisma.backendConnection.port }}
        user: {{ .Values.prisma.backendConnection.user }}
        password: {{ .Values.prisma.backendConnection.pass }}
        database: {{ printf "%s_houston" (.Release.Name | replace "-" "_")  }}
        {{ else }}
        uri: $PRISMA_DB_URI
        {{ end }}
        migrations: true
        # 2 is the minimum allowed value
        # There is one connection reserved
        # for management operations, so the queries
        # can make use of one less than the configured
        # number here.
        connectionLimit: 5
