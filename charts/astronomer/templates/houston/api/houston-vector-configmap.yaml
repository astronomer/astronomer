##########################################
## Houston API Vector ConfigMap          ##
## Vector pipeline for audit log shipping ##
##########################################
{{- if .Values.houston.loggingSidecar.enabled }}
{{- if or (eq .Values.global.plane.mode "control") (eq .Values.global.plane.mode "unified") }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-houston-vector-config
  namespace: {{ .Release.Namespace }}
  labels:
    tier: astronomer
    component: houston
    chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
    plane: {{ .Values.global.plane.mode }}
data:
  vector.yaml: |
    api:
      enabled: true
      address: "0.0.0.0:8686"

    data_dir: "/var/lib/vector"

    sources:
      houston_logs:
        type: file
        include:
          - /var/log/sidecar-log-consumer/*.log
        read_from: beginning
        max_line_bytes: 102400
        fingerprint:
          strategy: device_and_inode

    transforms:
      parse_json:
        type: remap
        inputs:
          - houston_logs
        source: |
          parsed, err = parse_json(.message)
          if err == null && is_object(parsed) {
            . = merge!(., parsed)
          }

      filter_logs:
        type: filter
        inputs:
          - parse_json
        condition:
          type: vrl
          source: |
            exists(.audit) && .audit == true

      enrich_metadata:
        type: remap
        inputs:
          - filter_logs
        source: |
          .kubernetes = {
            "pod_name": get_env_var!("VECTOR_POD_NAME"),
            "pod_namespace": get_env_var!("VECTOR_NAMESPACE"),
            "node_name": get_env_var!("VECTOR_SELF_NODE_NAME"),
            "container_name": "houston"
          }
          .platform = "astronomer-control-plane"
          .component = "houston-api"
          .service = "houston-api"
          if !exists(.timestamp) {
            .@timestamp = now()
          } else {
            .@timestamp = .timestamp
            del(.timestamp)
          }
          del(.file)
          del(.stream)
          del(.source_type)
          del(.host)

      normalize_levels:
        type: remap
        inputs:
          - enrich_metadata
        source: |
          if exists(.level) {
            .level = upcase!(.level)
          }

    sinks:
    {{- if .Values.houston.loggingSidecar.cloudwatch.enabled }}
      cloudwatch:
        type: aws_cloudwatch_logs
        inputs:
          - normalize_levels
        region: {{ .Values.houston.loggingSidecar.cloudwatch.region | quote }}
        group_name: {{ .Values.houston.loggingSidecar.cloudwatch.logGroupName | quote }}
        stream_name: "{{ "{{" }} kubernetes.pod_name {{ "}}" }}"
    {{- if not .Values.houston.loggingSidecar.cloudwatch.useIRSA }}
        auth:
          access_key_id: "${AWS_ACCESS_KEY_ID}"
          secret_access_key: "${AWS_SECRET_ACCESS_KEY}"
    {{- end }}
        encoding:
          codec: json
        batch:
          max_events: 100
          timeout_secs: 5
        request:
          retry_attempts: 5
          retry_initial_backoff_secs: 1
          retry_max_duration_secs: 300
          timeout_secs: 60
        buffer:
          type: memory
          max_events: 10000
          when_full: block
        healthcheck:
          enabled: true
    {{- end }}
    {{- if .Values.houston.loggingSidecar.gcpCloudLogging.enabled }}
      gcp_cloud_logging:
        type: gcp_stackdriver_logs
        inputs:
          - normalize_levels
        project_id: {{ .Values.houston.loggingSidecar.gcpCloudLogging.projectId | quote }}
        log_id: {{ .Values.houston.loggingSidecar.gcpCloudLogging.logId | quote }}
        severity_key: {{ .Values.houston.loggingSidecar.gcpCloudLogging.severityKey | quote }}
    {{- if not .Values.houston.loggingSidecar.gcpCloudLogging.useWorkloadIdentity }}
        credentials_path: "/etc/gcp-credentials/{{ .Values.houston.loggingSidecar.gcpCloudLogging.credentialsSecretKey }}"
    {{- end }}
        resource:
          type: {{ .Values.houston.loggingSidecar.gcpCloudLogging.resource.type | quote }}
          project_id: {{ .Values.houston.loggingSidecar.gcpCloudLogging.projectId | quote }}
          location: "{{ "{{" }} kubernetes.pod_namespace {{ "}}" }}"
          namespace_name: "{{ "{{" }} kubernetes.pod_namespace {{ "}}" }}"
          pod_name: "{{ "{{" }} kubernetes.pod_name {{ "}}" }}"
          container_name: "houston"
          cluster_name: {{ .Values.global.clusterName | default "unknown" | quote }}
        labels:
          component: "houston-api"
        batch:
          max_events: 100
          timeout_secs: 5
        buffer:
          type: memory
          max_events: 10000
          when_full: block
    {{- end }}
    {{- if .Values.houston.loggingSidecar.elasticsearch.enabled }}
      elasticsearch:
        type: elasticsearch
        inputs:
          - normalize_levels
        endpoints: ["${ES_ENDPOINT}"]
        api_version: {{ .Values.houston.loggingSidecar.elasticsearch.apiVersion | quote }}
    {{- if and (eq .Values.houston.loggingSidecar.elasticsearch.auth.strategy "basic") .Values.houston.loggingSidecar.elasticsearch.endpoint }}
        auth:
          strategy: basic
          user: "${ES_USERNAME}"
          password: "${ES_PASSWORD}"
    {{- end }}
        mode: bulk
        bulk:
          index: {{ .Values.houston.loggingSidecar.elasticsearch.index | quote }}
          action: create
        batch:
          max_bytes: 10485760
          timeout_secs: 5
        request:
          retry_attempts: 5
          retry_initial_backoff_secs: 1
          retry_max_duration_secs: 60
          timeout_secs: 120
        buffer:
          type: memory
          max_events: 10000
          when_full: block
        healthcheck:
          enabled: true
    {{- if .Values.houston.loggingSidecar.elasticsearch.tls.enabled }}
        tls:
          ca_file: "/etc/es-tls/ca.pem"
          verify_certificate: true
    {{- end }}
    {{- end }}
{{- end }}
{{- end }}
