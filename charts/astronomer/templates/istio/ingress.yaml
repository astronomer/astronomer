{{- if  .Values.global.serviceMesh.enabled  }}
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: {{ .Release.Name }}-houston
spec:
  hosts:
  - "houston.{{ .Values.global.baseDomain }}"
  gateways:
  - {{ .Release.Name }}-platform-gateway
  http:
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        port:
          number: 8871
        host: {{ .Release.Name }}-houston
      headers:
        response:
          set:
            Content-Security-Policy: 'default-src ''self'' *.{{ .Values.global.baseDomain }}; script-src
              ''unsafe-inline'' ''unsafe-eval'' *.{{ .Values.global.baseDomain }} cdn.jsdelivr.net
              cdn.astronomer.io cdn.metarouter.io cdn.segment.com www.google-analytics.com
              js.stripe.com widget.intercom.io js.intercomcdn.com cdn.lr-ingest.io;
              img-src ''self'' data: *; connect-src *.{{ .Values.global.baseDomain }} wss://*.{{ .Values.global.baseDomain }}
              e.metarouter.io api.segment.com api.segment.io api-iam.intercom.io wss://nexus-websocket-a.intercom.io
              https://grafana.com/blog/news.xml; style-src ''unsafe-inline'' *.{{ .Values.global.baseDomain }}
              cdn.jsdelivr.net fonts.googleapis.com; frame-src js.stripe.com; font-src
              *.{{ .Values.global.baseDomain }} cdn.astronomer.io fonts.gstatic.com js.intercomcdn.com
              data:; worker-src blob:'
            Permissions-Policy: "autoplay 'none'; camera 'none'; encrypted-media 'none'; fullscreen 'none'; geolocation 'none'; microphone 'none'; midi 'none'; payment 'none'; xr-spatial-tracking 'none'"
            Referrer-Policy: same-origin
            Strict-Transport-Security: max-age=31536000; includeSubDomains
            X-Content-Type-Options: nosniff
            X-Frame-Options: deny
            X-XSS-Protection: 1; mode=block
    corsPolicy:
      maxAge: 15m
      allowCredentials: true
      allowMethods:
      - GET
      - POST
      - OPTIONS
      allowHeaders:
      - Content-Type
      - Authorization
      - Content-Length
      - X-Requested-With
      - X-Apollo-Tracing
      - X-Client-Type
      allowOrigins:
        - exact: "https://app.{{ .Values.global.baseDomain }}"
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: {{ .Release.Name }}-astro-ui
spec:
  hosts:
  - "app.{{ .Values.global.baseDomain }}"
  gateways:
  - {{ .Release.Name }}-platform-gateway
  http:
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        port:
          number: 8080
        host: {{ .Release.Name }}-astro-ui
      headers:
        response:
          set:
            Content-Security-Policy: 'default-src ''self'' *.{{ .Values.global.baseDomain }}; script-src
              ''unsafe-inline'' ''unsafe-eval'' *.{{ .Values.global.baseDomain }} cdn.jsdelivr.net
              cdn.astronomer.io cdn.metarouter.io cdn.segment.com www.google-analytics.com
              js.stripe.com widget.intercom.io js.intercomcdn.com cdn.lr-ingest.io;
              img-src ''self'' data: *; connect-src *.{{ .Values.global.baseDomain }} wss://*.{{ .Values.global.baseDomain }}
              e.metarouter.io api.segment.com api.segment.io api-iam.intercom.io wss://nexus-websocket-a.intercom.io
              https://grafana.com/blog/news.xml; style-src ''unsafe-inline'' *.{{ .Values.global.baseDomain }}
              cdn.jsdelivr.net fonts.googleapis.com; frame-src js.stripe.com; font-src
              *.{{ .Values.global.baseDomain }} cdn.astronomer.io fonts.gstatic.com js.intercomcdn.com
              data:; worker-src blob:'
            Permissions-Policy: "autoplay 'none'; camera 'none'; encrypted-media 'none'; fullscreen 'none'; geolocation 'none'; microphone 'none'; midi 'none'; payment 'none'; xr-spatial-tracking 'none'"
            Referrer-Policy: same-origin
            Strict-Transport-Security: max-age=31536000; includeSubDomains
            X-Content-Type-Options: nosniff
            X-Frame-Options: deny
            X-XSS-Protection: 1; mode=block
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: {{ .Release.Name }}-registry
spec:
  hosts:
  - "registry.{{ .Values.global.baseDomain }}"
  gateways:
  - {{ .Release.Name }}-platform-gateway
  http:
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        port:
          number: 5000
        host: {{ .Release.Name }}-registry
      headers:
        response:
          set:
            Content-Security-Policy: 'default-src ''self'' *.{{ .Values.global.baseDomain }}; script-src
              ''unsafe-inline'' ''unsafe-eval'' *.{{ .Values.global.baseDomain }} cdn.jsdelivr.net
              cdn.astronomer.io cdn.metarouter.io cdn.segment.com www.google-analytics.com
              js.stripe.com widget.intercom.io js.intercomcdn.com cdn.lr-ingest.io;
              img-src ''self'' data: *; connect-src *.{{ .Values.global.baseDomain }} wss://*.{{ .Values.global.baseDomain }}
              e.metarouter.io api.segment.com api.segment.io api-iam.intercom.io wss://nexus-websocket-a.intercom.io
              https://grafana.com/blog/news.xml; style-src ''unsafe-inline'' *.{{ .Values.global.baseDomain }}
              cdn.jsdelivr.net fonts.googleapis.com; frame-src js.stripe.com; font-src
              *.{{ .Values.global.baseDomain }} cdn.astronomer.io fonts.gstatic.com js.intercomcdn.com
              data:; worker-src blob:'
            Permissions-Policy: "autoplay 'none'; camera 'none'; encrypted-media 'none'; fullscreen 'none'; geolocation 'none'; microphone 'none'; midi 'none'; payment 'none'; xr-spatial-tracking 'none'"
            Referrer-Policy: same-origin
            Strict-Transport-Security: max-age=31536000; includeSubDomains
            X-Content-Type-Options: nosniff
            X-Frame-Options: deny
            X-XSS-Protection: 1; mode=block
            Strict-Transport-Security: max-age=31536000
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: {{ .Release.Name }}-cli-install
spec:
  hosts:
  - "install.{{ .Values.global.baseDomain }}"
  gateways:
  - {{ .Release.Name }}-platform-gateway
  http:
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        port:
          number: 8080
        host: {{ .Release.Name }}-cli-install
      headers:
        response:
          set:
            Content-Security-Policy: 'default-src ''self'' *.{{ .Values.global.baseDomain }}; script-src
              ''unsafe-inline'' ''unsafe-eval'' *.{{ .Values.global.baseDomain }} cdn.jsdelivr.net
              cdn.astronomer.io cdn.metarouter.io cdn.segment.com www.google-analytics.com
              js.stripe.com widget.intercom.io js.intercomcdn.com cdn.lr-ingest.io;
              img-src ''self'' data: *; connect-src *.{{ .Values.global.baseDomain }} wss://*.{{ .Values.global.baseDomain }}
              e.metarouter.io api.segment.com api.segment.io api-iam.intercom.io wss://nexus-websocket-a.intercom.io
              https://grafana.com/blog/news.xml; style-src ''unsafe-inline'' *.{{ .Values.global.baseDomain }}
              cdn.jsdelivr.net fonts.googleapis.com; frame-src js.stripe.com; font-src
              *.{{ .Values.global.baseDomain }} cdn.astronomer.io fonts.gstatic.com js.intercomcdn.com
              data:; worker-src blob:'
            Permissions-Policy: "autoplay 'none'; camera 'none'; encrypted-media 'none'; fullscreen 'none'; geolocation 'none'; microphone 'none'; midi 'none'; payment 'none'; xr-spatial-tracking 'none'"
            Referrer-Policy: same-origin
            Strict-Transport-Security: max-age=31536000; includeSubDomains
            X-Content-Type-Options: nosniff
            X-Frame-Options: deny
            X-XSS-Protection: 1; mode=block
{{- end }}
